name: XTDB Scan Perf
run-name: "Scan Perf (N Items: ${{ inputs.n_items || '10000000' }}, ID Type: ${{ inputs.id_type || 'uuid' }})"

on:
  workflow_dispatch:
    inputs:
      n_items:
        description: 'Number of items'
        required: false
        default: '10000000'
        type: string
      id_type:
        description: 'ID type (uuid, string, keyword)'
        required: false
        default: 'uuid'
        type: string
  schedule:
    - cron: '0 19 * * 1-5'

permissions:
  contents: write

jobs:
  scan-perf:
    if: github.event_name == 'workflow_dispatch' || github.repository == 'xtdb/xtdb'
    name: Scan Perf
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      - name: Set up JDK 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@ac2d340dc04d9e1113182899e983b5400c17cda1
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Run Scan Perf
        run: |
          ./gradlew scan-perf \
            -PtwelveGBJvm \
            -PnItems=${{ inputs.n_items || '10000000' }} \
            -PidType=${{ inputs.id_type || 'uuid' }} \
            -PbenchLogFile=benchmark.jsonl \
            2>&1 | tee benchmark.log

      - name: Extract Benchmark Results
        if: success()
        run: |
          set -euo pipefail
          N_ITEMS="${{ inputs.n_items || '10000000' }}"
          ID_TYPE="${{ inputs.id_type || 'uuid' }}"
          LABEL="n=${N_ITEMS},id=${ID_TYPE}"

          jq -s --arg label "$LABEL" '
            [ .[] | select(.stage and ."time-taken-ms") ] |
            [ .[] | select(.stage == "summary" or
                           .stage == "profile-scan-points" or
                           .stage == "profile-scan-sets" or
                           .stage == "profile-scan-content-key" or
                           .stage == "profile-scan-filters") ] |
            map({
              name: (.stage + " (" + $label + ")"),
              unit: "ms",
              value: (."time-taken-ms")
            })
          ' benchmark.jsonl > benchmark-result.json

      - name: Store Benchmark Result
        if: success() && github.ref == 'refs/heads/main'
        uses: benchmark-action/github-action-benchmark@4bdcce38c94cec68da58d012ac24b7b1155efe8b # v1
        with:
          tool: customSmallerIsBetter
          output-file-path: benchmark-result.json
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: dev/bench/scan-perf
          auto-push: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Compose Slack Message
        id: compose
        if: always()
        run: |
          set -euo pipefail
          N_ITEMS="${{ inputs.n_items || '10000000' }}"
          ID_TYPE="${{ inputs.id_type || 'uuid' }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "${{ job.status }}" = "success" ]; then
            EMOJI=":white_check_mark:"
            STATUS="Passed"
          else
            EMOJI=":x:"
            STATUS="Failed"
          fi

          DURATION=""
          if [ -f benchmark.log ]; then
            TIME_MS=$(grep '"stage":"summary"' benchmark.log | grep -o '"time-taken-ms":[0-9]*' | head -1 | cut -d: -f2 || true)
            if [ -n "$TIME_MS" ]; then
              TOTAL_SECS=$((TIME_MS / 1000))
              MINS=$((TOTAL_SECS / 60))
              SECS=$((TOTAL_SECS % 60))
              DURATION="${MINS}m ${SECS}s"
            fi
          fi

          {
            echo 'msg<<EOF'
            if [ -n "$DURATION" ]; then
              echo "*Scan Perf Benchmark* completed in ${DURATION} — ${EMOJI} ${STATUS}"
            else
              echo "*Scan Perf Benchmark* — ${EMOJI} ${STATUS}"
            fi
            echo "N Items: ${N_ITEMS} | ID Type: ${ID_TYPE}"
            echo ":link: <${RUN_URL}|view run>"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Prepare Slack Message
        if: always()
        run: |
          jq -n --arg channel "$SLACK_CHANNEL" --arg text "$SLACK_MESSAGE" \
            '{channel: $channel, text: $text}' > slack-message.json
        env:
          SLACK_CHANNEL: ${{ secrets.BENCHMARK_SLACK_CHANNEL_ID }}
          SLACK_MESSAGE: ${{ steps.compose.outputs.msg }}

      - name: Post Slack Notification
        if: always()
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.BENCHMARK_SLACK_BOT_TOKEN }}
          payload-file-path: ./slack-message.json
